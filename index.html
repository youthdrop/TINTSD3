<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TINTSD — Divisions Shaded + Pins by Race (24 parts)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <style>
    /* Make the map truly full screen, overriding site CSS */
    html, body { height:100%; margin:0; padding:0; }
    #map{ height:100vh; margin:0; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script>
    /* -------- Tiny status box (helps find 404s quickly) -------- */
    const statusBox = (msg, isErr=false) => {
      let el = document.getElementById('load-status');
      if (!el) {
        el = document.createElement('div');
        el.id = 'load-status';
        el.style.position='absolute'; el.style.top='10px'; el.style.right='10px';
        el.style.background='#fff'; el.style.border='1px solid #999';
        el.style.padding='8px 10px'; el.style.borderRadius='6px';
        el.style.font='13px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial';
        el.style.maxWidth='320px'; el.style.boxShadow='0 2px 8px rgba(0,0,0,.08)';
        document.body.appendChild(el);
      }
      el.innerHTML += `<div style="color:${isErr?'#b00020':'#111'}">${msg}</div>`;
    };

    /* -------- Division colors (for polygon shading) -------- */
    const DIV_COLORS = {
      "Central": "#1976d2","Mid-City": "#2e7d32","Southeastern": "#d32f2f",
      "Eastern": "#ef6c00","Southern": "#8e0000","Northern": "#00838f",
      "Western": "#6a1b9a","Northeastern": "#0d47a1","Northwestern": "#43a047",
      "Unknown": "#616161"
    };
    function normDivision(name){
      if(!name) return "Unknown";
      const n=String(name).trim().toLowerCase().replace(/\s*division\s*$/,'');
      if(/^mid[-\s]?city$/.test(n)) return "Mid-City";
      if(n==="central") return "Central";
      if(n==="eastern") return "Eastern";
      if(n==="northern") return "Northern";
      if(n==="northwestern") return "Northwestern";
      if(n==="northeastern") return "Northeastern";
      if(n==="southeastern") return "Southeastern";
      if(n==="southern") return "Southern";
      if(n==="western") return "Western";
      return "Unknown";
    }

    /* -------- Pin colors by Race (normalize variants) -------- */
    const RACE_COLORS = {
      "White":"#ffffff","Black":"#111111","Hispanic/Latino":"#ff8800",
      "Asian":"#0066ff","Pacific Islander":"#00c4a7",
      "Middle Eastern/South Asian":"#8e24aa","Native American":"#b5651d",
      "Unknown":"#888888"
    };
    function normRace(r){
      if(!r) return "Unknown";
      const s=String(r).trim().toLowerCase();
      if(s.includes("black")) return "Black";
      if(s==="white") return "White";
      if(s.includes("hispanic")||s.includes("latino")||s.includes("latine")) return "Hispanic/Latino";
      if(s==="asian") return "Asian";
      if(s.includes("pacific")) return "Pacific Islander";
      if(s.includes("middle eastern")||s.includes("south asian")) return "Middle Eastern/South Asian";
      if(s.includes("native american")||s.includes("american indian")||s.includes("alaska")) return "Native American";
      return "Unknown";
    }

    /* -------- Map base -------- */
    const map = L.map('map').setView([32.75, -117.12], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      maxZoom:19, attribution:'© OpenStreetMap'
    }).addTo(map);

    /* -------- Shade division polygons -------- */
    const DIVISIONS_GEOJSON_URL = 'pd_divisions_datasd.geojson';
    const getDivProp = p => p?.DIVISION ?? p?.Division ?? p?.division ?? p?.Div_Name ?? p?.DIV_NAME ?? p?.DivName ?? p?.name ?? '';
    fetch(DIVISIONS_GEOJSON_URL + `?v=${Date.now()}`)
      .then(r => { if(!r.ok) throw new Error(`${r.status} ${DIVISIONS_GEOJSON_URL}`); return r.json(); })
      .then(geo => {
        L.geoJSON(geo,{
          style: f=>{
            const d = normDivision(getDivProp(f.properties||{}));
            const c = DIV_COLORS[d]||DIV_COLORS.Unknown;
            return {color:c,weight:2,fillColor:c,fillOpacity:0.15};
          },
          onEachFeature:(f,layer)=>{
            const d = normDivision(getDivProp(f.properties||{}));
            layer.bindTooltip(d,{sticky:true});
          }
        }).addTo(map);
        statusBox('Divisions loaded ✓');
      })
      .catch(e=>statusBox(`Division polygons failed: ${e.message}`, true));

    /* -------- Cluster for all stops (24 JSON files) -------- */
    const cluster = L.markerClusterGroup({ disableClusteringAtZoom: 15 }).addTo(map);

    // Your files are in /parts and named part_01.json .. part_24.json
    const PARTS = Array.from({length:24},(_,i)=>`parts/part_${String(i+1).padStart(2,'0')}.json`);

    function addStop(rec){
      const div = normDivision(rec.Division);
      const race = normRace(rec.Race);
      const lat = parseFloat(rec.lat), lon = parseFloat(rec.lon);
      if(isNaN(lat)||isNaN(lon)) return;

      const marker = L.circleMarker([lat,lon],{
        radius:6, color:"#333",
        fillColor: RACE_COLORS[race]||RACE_COLORS.Unknown,
        fillOpacity:0.9, weight:1
      }).bindPopup(`
        <div style="font-size:13px;line-height:1.4">
          <b>Division:</b> ${div}<br/>
          <b>Beat:</b> ${rec.beatName ?? ""}<br/>
          ${rec.street ? `<b>Street:</b> ${rec.street}<br/>` : ""}
          ${rec.Race ? `<b>Race:</b> ${rec.Race}` : ""}
        </div>
      `);
      cluster.addLayer(marker);
    }

    (async function loadParts(){
      let loaded=0, added=0;
      for(const url of PARTS){
        try{
          const res = await fetch(url + `?v=${Date.now()}`); // cache-bust
          if(!res.ok){ statusBox(`Missing: ${url} (${res.status})`, true); continue; }
          const data = await res.json();  // array
          data.forEach(addStop);
          loaded++; added += data.length;
          statusBox(`Loaded ${url} — total pins on map: ${added.toLocaleString()}`);
        }catch(e){
          statusBox(`Error loading ${url}: ${e.message}`, true);
        }
      }
      if (loaded===0) statusBox('No parts loaded — check folder/name pattern.', true);
    })();
  </script>
</body>
</html>
